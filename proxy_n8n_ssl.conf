# --- n8n via Apache reverse proxy (SSL vhost) ---
# Requisitos: mod_proxy, mod_proxy_http, mod_headers
# (Opcional: mod_proxy_wstunnel se for usar websocket)
#
# Caminho típico cPanel:
# /etc/apache2/conf.d/userdata/ssl/2_4/<usuario>/<host>/proxy_n8n.conf

# Força HTTP/1.1 (SSE mais estável)
ProtocolsHonorOrder On
Protocols http/1.1

ProxyPreserveHost On
ProxyRequests Off
ProxyAddHeaders On
ProxyTimeout 900
AllowEncodedSlashes NoDecode

# Cookies/paths reversos
ProxyPassReverseCookieDomain 127.0.0.1 ia.cursatto.com.br
ProxyPassReverseCookiePath / /

# Forward headers (n8n atrás do proxy)
RequestHeader unset X-Forwarded-Host
RequestHeader set   X-Forwarded-Host  "ia.cursatto.com.br" early
RequestHeader set   X-Forwarded-Proto "https" early
RequestHeader set   X-Forwarded-Port  "443" early
RequestHeader set   X-Real-IP "%{REMOTE_ADDR}s" early
RequestHeader add   X-Forwarded-For "%{REMOTE_ADDR}s" early

# =====================================================================
# PUSH do n8n (SSE) - /rest/push
# =====================================================================
# Garante ORIGIN SEMPRE no /rest/push (porque alguns clientes/proxys mandam vazio)
SetEnvIfNoCase Request_URI "^/rest/push($|/)" IS_N8N_PUSH=1
RequestHeader set Origin "https://ia.cursatto.com.br" early env=IS_N8N_PUSH

# Requer mod_proxy_wstunnel carregado
ProxyPass        "/rest/push"  "ws://127.0.0.1:5678/rest/push" retry=0 timeout=900
ProxyPassReverse "/rest/push"  "ws://127.0.0.1:5678/rest/push"

# =====================================================================
# Demais rotas do n8n
# =====================================================================
ProxyPass        "/"  "http://127.0.0.1:5678/" connectiontimeout=60 timeout=900 keepalive=On
ProxyPassReverse "/"  "http://127.0.0.1:5678/"

# Permitir payloads grandes (opcional)
LimitRequestBody 0
