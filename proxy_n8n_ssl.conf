# /etc/apache2/conf.d/userdata/ssl/2_4/iacursattocom/ia.cursatto.com.br/proxy_n8n.conf

# --- n8n via Apache reverse proxy (SSL vhost, SSE-only) ---
# Requisitos: mod_proxy, mod_proxy_http, mod_headers, mod_rewrite
# Caminho típico no cPanel:
# /etc/apache2/conf.d/userdata/ssl/2_4/iacursattocom/ia.cursatto.com.br/proxy_n8n.conf

# Força HTTP/1.1 (SSE estável atrás de proxy)
Protocols http/1.1

ProxyPreserveHost On
ProxyRequests Off
AllowEncodedSlashes NoDecode
ProxyAddHeaders On
ProxyTimeout 900

# Normaliza cabeçalhos de forward (evita duplicar X-Forwarded-Host)
RequestHeader unset X-Forwarded-Host
RequestHeader set   X-Forwarded-Host "ia.cursatto.com.br" early
RequestHeader set   X-Forwarded-Proto "https" early
RequestHeader set   X-Forwarded-Port  "443"   early

# --- injeta Origin SOMENTE se vier vazio no /rest/push (SSE) ---
RewriteEngine On
RewriteCond %{REQUEST_URI} ^/rest/push [NC]
RewriteCond %{HTTP:Origin} ^$ [NC]
RewriteRule ^ - [E=MISSING_ORIGIN:1]
RequestHeader set Origin "https://ia.cursatto.com.br" env=MISSING_ORIGIN

# --- PUSH por SSE (HTTP), sem websocket e sem nocanon ---
ProxyPass        /rest/push  http://127.0.0.1:5678/rest/push keepalive=On retry=0 flushpackets=on timeout=900
ProxyPassReverse /rest/push  http://127.0.0.1:5678/rest/push

# --- Demais rotas para o n8n ---
ProxyPass        /  http://127.0.0.1:5678/ connectiontimeout=60 timeout=900 keepalive=On
ProxyPassReverse /  http://127.0.0.1:5678/

# Permitir payloads grandes (opcional)
LimitRequestBody 0

